# GitHub Actions Runner Controller (ARC) - AutoscalingRunnerSet
# 
# Before applying, you must:
#   1. Replace {organization-name-here} with your GitHub org or org/repo
#   2. Create a secret with your GitHub App or PAT credentials:
#      kubectl create secret generic arc-runner-set-gha-rs-github-secret \
#        --namespace=arc-runners \
#        --from-literal=github_token=<YOUR_GITHUB_PAT>
#
apiVersion: actions.github.com/v1alpha1
kind: AutoscalingRunnerSet
metadata:
  annotations:
    actions.github.com/cleanup-github-secret-name: arc-runner-set-gha-rs-github-secret
    actions.github.com/cleanup-manager-role-binding: arc-runner-set-gha-rs-manager
    actions.github.com/cleanup-manager-role-name: arc-runner-set-gha-rs-manager
    actions.github.com/cleanup-no-permission-service-account-name: arc-runner-set-gha-rs-no-permission
    actions.github.com/runner-group-name: Default
    actions.github.com/runner-scale-set-name: arc-runner-set
    meta.helm.sh/release-name: arc-runner-set
    meta.helm.sh/release-namespace: arc-runners
  labels:
    actions.github.com/organization: {organization-name-here}  # <-- REPLACE
    actions.github.com/scale-set-name: arc-runner-set
    actions.github.com/scale-set-namespace: arc-runners
    app.kubernetes.io/component: autoscaling-runner-set
    app.kubernetes.io/instance: arc-runner-set
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: arc-runner-set
    app.kubernetes.io/part-of: gha-rs
    app.kubernetes.io/version: 0.13.0
    helm.sh/chart: gha-rs-0.13.0
  name: arc-runner-set
  namespace: arc-runners
spec:
  githubConfigSecret: arc-runner-set-gha-rs-github-secret
  githubConfigUrl: https://github.com/{organization-name-here}  # <-- REPLACE (org or org/repo)
  listenerTemplate:
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: workload-type
                    operator: In
                    values:
                      - system
      containers:
        - image: ghcr.io/actions/gha-runner-scale-set-controller:0.13.0
          imagePullPolicy: Always
          name: listener
      tolerations:
        - effect: NoSchedule
          key: workload-type
          operator: Equal
          value: system
  maxRunners: 10
  minRunners: 0
  template:
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: workload-type
                    operator: In
                    values:
                      - build-runner
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/part-of
                    operator: In
                    values:
                      - gha-rs
              topologyKey: kubernetes.io/hostname
      containers:
        - command:
            - /home/runner/run.sh
          image: ghcr.io/actions/actions-runner:latest 
          name: runner
          # Resource requests/limits - ADJUST FOR YOUR INSTANCE TYPE
          # These values are tuned for AWS EC2 c8i.4xlarge (16 vCPU, 32GB RAM)
          # Modify based on your node size, or remove to use defaults
          resources:
            limits:
              cpu: '15'
              memory: 26Gi
            requests:
              cpu: '15'
              memory: 26Gi
      restartPolicy: Never
      serviceAccountName: arc-runner-set-gha-rs-no-permission
